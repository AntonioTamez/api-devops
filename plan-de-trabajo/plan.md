# Plan de Implementaci√≥n - API .NET 8 con DevOps Automatizado

## üìã Resumen Ejecutivo

Proyecto completo de API REST en .NET 8 con infraestructura automatizada usando Azure, Terraform, Docker y CI/CD con GitHub Actions.

---

## üéØ Objetivos

- Crear API REST en .NET 8 con Swagger integrado
- Contenedorizar la aplicaci√≥n con Docker
- Provisionar infraestructura en Azure usando Terraform
- Implementar CI/CD automatizado con GitHub Actions
- Deploy autom√°tico al hacer PR a rama `master`

---

## üèóÔ∏è Stack Tecnol√≥gico

### Backend
- **.NET 8** - ASP.NET Core Web API
- **Entity Framework Core 8** - ORM
- **Swagger/OpenAPI** - Documentaci√≥n de API
- **xUnit** - Testing framework

### Base de Datos
- **Azure SQL Database** - SQL Server en la nube
- **SQL Server 2022** - Para desarrollo local (Docker)

### Contenedorizaci√≥n
- **Docker** - Contenedores
- **Docker Compose** - Orquestaci√≥n local
- **Azure Container Registry (ACR)** - Registro de im√°genes

### Infraestructura
- **Terraform** - Infrastructure as Code
- **Azure** - Cloud provider

### CI/CD
- **GitHub Actions** - Pipeline de deployment
- **Azure DevOps** - (Alternativa opcional)

---

## üèõÔ∏è Arquitectura Azure

### Recursos de Azure a Provisionar

1. **Azure Resource Group**
   - Contenedor l√≥gico de todos los recursos
   - Ambiente: Development, Production

2. **Azure Container Registry (ACR)**
   - Registro privado de im√°genes Docker
   - SKU: Basic (dev), Standard (prod)

3. **Azure Container Apps**
   - Hosting del API (serverless)
   - Auto-scaling basado en demanda
   - HTTPS autom√°tico

4. **Azure SQL Database**
   - SQL Server como servicio
   - SKU: Basic (dev), Standard S2 (prod)
   - Backup autom√°tico

5. **Azure Application Insights**
   - Monitoreo de aplicaci√≥n
   - Telemetr√≠a y logs
   - Performance metrics

6. **Azure Key Vault**
   - Gesti√≥n segura de secrets
   - Connection strings
   - API keys

7. **Azure Virtual Network** (Opcional)
   - Red privada
   - Seguridad adicional

---

## üìÅ Estructura del Proyecto

```
api-devops/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml              # Pipeline CI/CD
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Program.cs                  # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ DevOpsApi.csproj           # Proyecto .NET
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.json           # Configuraci√≥n local
‚îÇ   ‚îú‚îÄ‚îÄ appsettings.Production.json # Configuraci√≥n producci√≥n
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProductsController.cs   # CRUD de productos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ HealthController.cs     # Health checks
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Product.cs              # Entidad de producto
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ApiDbContext.cs         # EF Core DbContext
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IProductService.cs      # Interface
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProductService.cs       # Implementaci√≥n
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ Migrations/                 # EF Core migrations
‚îÇ       ‚îî‚îÄ‚îÄ InitialCreate.cs
‚îÇ
‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îú‚îÄ‚îÄ main.tf                     # Recursos principales
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf                # Variables parametrizables
‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf                  # Outputs del deployment
‚îÇ   ‚îú‚îÄ‚îÄ providers.tf                # Azure provider config
‚îÇ   ‚îî‚îÄ‚îÄ environments/
‚îÇ       ‚îú‚îÄ‚îÄ dev.tfvars             # Variables desarrollo
‚îÇ       ‚îî‚îÄ‚îÄ prod.tfvars            # Variables producci√≥n
‚îÇ
‚îú‚îÄ‚îÄ Dockerfile                      # Imagen Docker multi-stage
‚îú‚îÄ‚îÄ docker-compose.yml              # Ambiente local completo
‚îú‚îÄ‚îÄ .dockerignore                   # Exclusiones Docker
‚îú‚îÄ‚îÄ .gitignore                      # Exclusiones Git
‚îú‚îÄ‚îÄ README.md                       # Documentaci√≥n del proyecto
‚îî‚îÄ‚îÄ plan.md                         # Este archivo
```

---

## üê≥ Docker Setup

### Dockerfile Multi-Stage

**Stage 1: Build**
- Imagen base: `mcr.microsoft.com/dotnet/sdk:8.0`
- Restore de dependencias
- Build del proyecto
- Publish optimizado

**Stage 2: Runtime**
- Imagen base: `mcr.microsoft.com/dotnet/aspnet:8.0`
- Solo runtime (imagen ligera)
- Copy de archivos publicados
- Exposici√≥n de puerto 8080

### docker-compose.yml

**Servicios:**

1. **api**
   - Puerto: 5000 (HTTP), 5001 (HTTPS)
   - Dependencia: SQL Server
   - Variables de entorno
   - Connection string

2. **sqlserver**
   - Imagen: `mcr.microsoft.com/mssql/server:2022-latest`
   - Puerto: 1433
   - SA password
   - Volumen persistente: `sqldata`

---

## üîß Terraform - Infraestructura como C√≥digo

### Archivos de Terraform

#### providers.tf
```hcl
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
  backend "azurerm" {
    # State file en Azure Storage
  }
}

provider "azurerm" {
  features {}
}
```

#### variables.tf
Variables parametrizables:
- `environment` (dev, prod)
- `location` (East US, West Europe)
- `sql_admin_username`
- `sql_admin_password` (sensitive)
- `container_registry_sku`
- `sql_database_sku`

#### main.tf
Recursos a crear:
- Resource Group
- Container Registry
- Container App Environment
- Container App
- SQL Server
- SQL Database
- Application Insights
- Key Vault
- Key Vault Secrets (connection strings)

#### outputs.tf
Outputs importantes:
- Container App URL
- SQL Server FQDN
- Application Insights connection string
- Container Registry login server

---

## üöÄ CI/CD Pipeline - GitHub Actions

### Archivo: `.github/workflows/deploy.yml`

### Triggers
```yaml
on:
  push:
    branches:
      - master      # Deploy autom√°tico a producci√≥n
  pull_request:
    branches:
      - master      # Solo build y test
```

### Jobs

#### 1. Build and Test
```yaml
- Checkout c√≥digo
- Setup .NET 8
- Restore dependencies
- Build proyecto
- Run unit tests
- Run EF Core migration check
- Code coverage report
```

#### 2. Build Docker Image
```yaml
- Login to Azure Container Registry
- Build imagen Docker
- Tag con SHA + timestamp
- Push imagen a ACR
```

#### 3. Terraform Apply
```yaml
- Login to Azure (Service Principal)
- Terraform init
- Terraform plan
- Terraform apply (auto-approve en master)
- Store terraform outputs
```

#### 4. Deploy Application
```yaml
- Update Azure Container App
- Set nueva imagen desde ACR
- Run EF Core migrations
- Health check validation
- Rollback si falla health check
- Notification (Slack/Teams)
```

---

## üîê Secrets de GitHub

Configurar en: **Settings ‚Üí Secrets and variables ‚Üí Actions**

### Secrets Requeridos

1. **`AZURE_CREDENTIALS`**
   ```json
   {
     "clientId": "xxx",
     "clientSecret": "xxx",
     "subscriptionId": "xxx",
     "tenantId": "xxx"
   }
   ```

2. **`AZURE_SUBSCRIPTION_ID`** - ID de suscripci√≥n Azure

3. **`ACR_LOGIN_SERVER`** - URL del Container Registry

4. **`ACR_USERNAME`** - Admin username del ACR

5. **`ACR_PASSWORD`** - Admin password del ACR

6. **`SQL_ADMIN_PASSWORD`** - Password del SQL Server

---

## üì¶ Dependencias del Proyecto .NET

### Paquetes NuGet

```xml
<PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0" />
<PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
<PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
<PackageReference Include="Microsoft.ApplicationInsights.AspNetCore" Version="2.22.0" />
<PackageReference Include="Azure.Identity" Version="1.10.0" />
<PackageReference Include="Azure.Security.KeyVault.Secrets" Version="4.5.0" />
```

---

## üé¨ Comandos de Inicio R√°pido

### 1. Crear Proyecto .NET 8

```bash
cd c:/ATS/GIT/api-devops
dotnet new webapi -n DevOpsApi -o src
cd src
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
dotnet add package Microsoft.EntityFrameworkCore.Design
dotnet add package Swashbuckle.AspNetCore
dotnet add package Azure.Identity
dotnet add package Microsoft.ApplicationInsights.AspNetCore
```

### 2. Crear Estructura de Base de Datos

```bash
# Crear DbContext y modelos
# ... (c√≥digo C#)

# Crear migraci√≥n inicial
dotnet ef migrations add InitialCreate

# Aplicar migraci√≥n
dotnet ef database update
```

### 3. Levantar Ambiente Local

```bash
# Levantar contenedores
docker-compose up -d

# Ver logs
docker-compose logs -f api

# Detener contenedores
docker-compose down
```

### 4. Acceder a la API Local

- **Swagger UI**: http://localhost:5000
- **API**: http://localhost:5000/api
- **Health Check**: http://localhost:5000/health

### 5. Terraform - Provisionar Infraestructura

```bash
cd terraform

# Inicializar
terraform init

# Planificar cambios
terraform plan -var-file="environments/dev.tfvars"

# Aplicar cambios
terraform apply -var-file="environments/prod.tfvars"

# Ver outputs
terraform output
```

---

## üîÑ Flujo de Trabajo (Workflow)

### Desarrollo Local

1. Desarrollador crea feature branch
2. Desarrolla y prueba localmente con `docker-compose`
3. Commit y push a GitHub
4. Crea Pull Request a `master`

### Pull Request

1. GitHub Actions ejecuta pipeline
2. **Build** del proyecto
3. **Tests** unitarios e integraci√≥n
4. **Build** de imagen Docker
5. **Validaci√≥n** de Terraform (plan)
6. Revisi√≥n de c√≥digo por equipo

### Merge a Master

1. Merge aprobado
2. GitHub Actions ejecuta pipeline completo
3. **Build** y push de imagen a ACR
4. **Terraform apply** - actualiza infraestructura
5. **Deploy** a Azure Container Apps
6. **Migrations** de EF Core
7. **Health check** post-deployment
8. **Notificaci√≥n** de √©xito/fallo

---

## üìä Monitoreo y Observabilidad

### Application Insights

- **Logs**: Todos los logs de la aplicaci√≥n
- **Metrics**: CPU, memoria, requests
- **Traces**: Distributed tracing
- **Exceptions**: Errores capturados
- **Dependencies**: SQL queries, HTTP calls

### Health Checks

Endpoints de health check:
- `/health` - Health general
- `/health/ready` - Readiness probe
- `/health/live` - Liveness probe

Checks incluidos:
- SQL Server connectivity
- Disk space
- Memory usage

---

## üîí Seguridad

### Buenas Pr√°cticas Implementadas

1. **Secrets en Key Vault** - No hardcodear credenciales
2. **HTTPS obligatorio** - Redirect HTTP ‚Üí HTTPS
3. **CORS configurado** - Pol√≠tica restrictiva en producci√≥n
4. **Connection strings encriptados**
5. **Service Principal** para GitHub Actions
6. **Least privilege** en permisos Azure
7. **SQL Server con firewall** - Solo IPs permitidas

---

## üìù Configuraci√≥n de Ambientes

### appsettings.json (Local)

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost,1433;Database=DevOpsDb;User Id=sa;Password=YourPassword123!;TrustServerCertificate=True"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

### appsettings.Production.json (Azure)

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "@Microsoft.KeyVault(SecretUri=https://myvault.vault.azure.net/secrets/sql-connection-string)"
  },
  "ApplicationInsights": {
    "ConnectionString": "..."
  }
}
```

---

## üß™ Testing

### Estructura de Tests

```
tests/
‚îú‚îÄ‚îÄ DevOpsApi.UnitTests/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProductsControllerTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ Services/
‚îÇ       ‚îî‚îÄ‚îÄ ProductServiceTests.cs
‚îÇ
‚îî‚îÄ‚îÄ DevOpsApi.IntegrationTests/
    ‚îî‚îÄ‚îÄ ApiTests.cs
```

### Comandos de Testing

```bash
# Run all tests
dotnet test

# Run con coverage
dotnet test --collect:"XPlat Code Coverage"

# Run espec√≠fico
dotnet test --filter "FullyQualifiedName~ProductsControllerTests"
```

---

## üìà Roadmap

### Fase 1 - MVP (Esta implementaci√≥n)
- ‚úÖ API .NET 8 con Swagger
- ‚úÖ Docker + Docker Compose
- ‚úÖ Terraform para Azure
- ‚úÖ CI/CD con GitHub Actions
- ‚úÖ SQL Server

### Fase 2 - Mejoras
- üî≤ Autenticaci√≥n JWT
- üî≤ Rate limiting
- üî≤ Redis para caching
- üî≤ API Gateway (Azure API Management)

### Fase 3 - Avanzado
- üî≤ Microservicios adicionales
- üî≤ Event-driven con Azure Service Bus
- üî≤ Azure Functions para workers
- üî≤ Kubernetes (AKS) en lugar de Container Apps

---

## üÜò Troubleshooting

### Problemas Comunes

**1. Docker no inicia SQL Server**
```bash
# Verificar logs
docker-compose logs sqlserver

# Recrear contenedor
docker-compose down -v
docker-compose up -d
```

**2. EF Migrations fallan**
```bash
# Verificar connection string
dotnet ef database update --verbose

# Recrear migraci√≥n
dotnet ef migrations remove
dotnet ef migrations add InitialCreate
```

**3. GitHub Actions falla en Deploy**
- Verificar secrets configurados
- Verificar Service Principal tiene permisos
- Revisar logs de Terraform

**4. Container App no levanta**
- Verificar imagen en ACR
- Revisar Application Insights logs
- Verificar variables de entorno

---

## üìö Recursos y Referencias

### Documentaci√≥n Oficial

- [ASP.NET Core](https://docs.microsoft.com/aspnet/core)
- [Entity Framework Core](https://docs.microsoft.com/ef/core)
- [Azure Container Apps](https://docs.microsoft.com/azure/container-apps)
- [Terraform Azure Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [GitHub Actions](https://docs.github.com/actions)

### Comandos √ötiles

```bash
# .NET
dotnet --version
dotnet build
dotnet run
dotnet ef migrations add <name>
dotnet ef database update

# Docker
docker build -t api-devops:latest .
docker run -p 5000:8080 api-devops:latest
docker-compose up -d
docker-compose logs -f

# Terraform
terraform init
terraform plan
terraform apply
terraform destroy
terraform output

# Azure CLI
az login
az account show
az group list
az container app list
```

---

## üë• Equipo y Contacto

- **Arquitecto**: DevOps Team
- **Email**: devops@example.com
- **Repository**: https://github.com/your-org/api-devops

---

## üìÑ Licencia

Este proyecto es de uso interno.

---

**√öltima actualizaci√≥n**: Octubre 2025
**Versi√≥n del plan**: 1.0
**Estado**: Listo para implementaci√≥n
